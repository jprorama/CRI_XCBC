---
- name: Get package facts
  ansible.builtin.package_facts:
    manager: "auto"

- name: Make sure lmod config is installed with cm version
  ansible.builtin.yum:
    name: cm-modules-init-client
    state: present
  when: '"cm" in ansible_facts.packages.Lmod[0].release'

- name: Enable Lmod
  replace:
    path: "{{ enable_lmod_prefix }}/etc/sysconfig/modules/lmod/{{ item.path }}"
    regexp: "{{ item.regexp }}"
    replace: "{{ item.replace }}"
  loop:
    - { path: 'cm-lmod-init.sh', regexp: 'LMOD=.*$', replace: 'LMOD=1'}
    - { path: 'cm-lmod-init.csh', regexp: 'LMOD.*$', replace: 'LMOD "1"'}
  when: '"cm" in ansible_facts.packages.Lmod[0].release'

- name: Put DefaultModules in place
  template:
    src: DefaultModules.lua.j2
    dest: "{{ enable_lmod_prefix }}/usr/share/modulefiles/DefaultModules.lua"
