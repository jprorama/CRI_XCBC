---
# cod compute-image build
- name: clone the default image to build a compute image
  command: cmsh -c "softwareimage; clone default-image compute-image; commit --wait"

- name: create a new category for the compute image
  command: cmsh -c "category; clone default compute; set softwareimage compute-image; roles; assign compute; commit --wait"

- name: Config for slurm-client role
  command: cmsh -c "configurationoverlay; use slurm-client; append categories compute; commit"

- name: Add software to the image
  yum:
    installroot: /cm/images/compute-image
    name:
      - ansible
      - bash-completion
      - git
      - nc
      - nfs-utils
      - python-websockify
      - python2-numpy
      - python3
      - python3-devel
      - ruby
      - shorewall
      - tmux
      - turbojpeg
      - vim
      - '@X Window System'
      - '@Xfce'

- name: Install TurboVNC via rpm
  yum:
    installroot: /cm/images/compute-image
    name: https://sourceforge.net/projects/turbovnc/files/2.2/turbovnc-2.2.x86_64.rpm
    state: present
    validate_certs: no

- name: Create a symlink for munge.key before enabling munge service
  file:
    state: link
    src: /cm/shared/apps/slurm/var/munge/keys/munge.key
    dest: /cm/images/compute-image/etc/munge/munge.key

- name: Create a directory for CRI_XCBC in the compute-image chroot path
  file:
    path: "{{ bright_cod_compute_chroot_loc }}/CRI_XCBC"
    state: directory
    mode: 0755
    owner: root
    group: root

- name: Mount dirs required for ansible scripts to function
  mount:
    src: /{{ item }}
    path: /cm/images/compute-image/{{ item }}
    opts: bind
    fstype: none
    state: mounted
  loop:
    - dev
    - proc
    - sys
    - home
    - CRI_XCBC

- name: Run the Ansible roles related to compute image
  command: ansible-playbook -c chroot -i '/cm/images/compute-image/CRI_XCBC/hosts' /CRI_XCBC/compute-cod.yaml -b

# cod compute node deploy
- name: Change node001 category to compute
  command: cmsh -c "device; use node001; set category compute; commit"

- name: Set DHCP on BOOTIF device
  command: cmsh -c "device; use node001; interfaces; use bootif; set dhcp yes; commit"

- name: Make sure tftp systemd service is running on head node
  systemd:
    state: started
    name: tftpd

- name: Reboot node001 to pick up the new image
  command: cmsh -c "device; use node001; reboot"
